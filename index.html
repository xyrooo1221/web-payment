env example:
WHATSAPP_TOKEN=EAAXXX...        # Your Meta WhatsApp Cloud API bearer token
WHATSAPP_PHONE_ID=123456789     # Your WhatsApp Business phone number ID (not the number)
VERIFY_TOKEN=myverifytoken      # webhook verification token you choose
PROVIDER_API_URL=https://api.example.com/topup
PROVIDER_API_KEY=your_provider_api_key
DB_HOST=localhost
DB_USER=root
DB_PASS=secret
DB_NAME=wa_topup

-- CONFIG AREA -- modify as needed --
*/

require('dotenv').config();
const express = require('express');
const bodyParser = require('body-parser');
const axios = require('axios');
const mysql = require('mysql2/promise');

const app = express();
app.use(bodyParser.json());

const WHATSAPP_TOKEN = process.env.WHATSAPP_TOKEN;
const WHATSAPP_PHONE_ID = process.env.WHATSAPP_PHONE_ID;
const VERIFY_TOKEN = process.env.VERIFY_TOKEN || 'verify_token';

const PROVIDER_API_URL = process.env.PROVIDER_API_URL; // e.g. https://api.provider.com/topup
const PROVIDER_API_KEY = process.env.PROVIDER_API_KEY;

const DB_CONFIG = {
  host: process.env.DB_HOST || 'localhost',
  user: process.env.DB_USER || 'root',
  password: process.env.DB_PASS || '',
  database: process.env.DB_NAME || 'wa_topup'
};

// Helper: send message via WhatsApp Cloud API
async function sendWhatsAppMessage(toPhoneNumber, text) {
  const url = `https://graph.facebook.com/v17.0/${WHATSAPP_PHONE_ID}/messages`;
  try {
    const payload = {
      messaging_product: 'whatsapp',
      to: toPhoneNumber,
      type: 'text',
      text: { body: text }
    };
    const res = await axios.post(url, payload, {
      headers: { Authorization: `Bearer ${WHATSAPP_TOKEN}` }
    });
    return res.data;
  } catch (err) {
    console.error('Error sending WA message', err.response ? err.response.data : err.message);
    throw err;
  }
}

// Helper: call provider API (generic example) -- adapt to provider spec
async function callProviderTopup(service, targetNumber, nominal, orderId) {
  // Example POST Body - change keys to match provider
  const body = {
    api_key: PROVIDER_API_KEY,
    service: service,
    target: targetNumber,
    amount: nominal,
    order_id: orderId
  };

  try {
    const res = await axios.post(PROVIDER_API_URL, body, { timeout: 20000 });
    return res.data; // provider response
  } catch (err) {
    console.error('Provider API error', err.response ? err.response.data : err.message);
    throw err;
  }
}

// Initialize DB (create table if not exists)
async function initDb() {
  const conn = await mysql.createConnection({
    host: DB_CONFIG.host,
    user: DB_CONFIG.user,
    password: DB_CONFIG.password
  });
  await conn.query(`CREATE DATABASE IF NOT EXISTS \\`${DB_CONFIG.database}\\``);
  await conn.end();

  const pool = await mysql.createPool(DB_CONFIG);
  const createTableSQL = `
    CREATE TABLE IF NOT EXISTS orders (
      id INT AUTO_INCREMENT PRIMARY KEY,
      order_id VARCHAR(64) UNIQUE,
      user_phone VARCHAR(32),
      service VARCHAR(64),
      target VARCHAR(64),
      nominal VARCHAR(32),
      status VARCHAR(32),
      provider_response TEXT,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    ) ENGINE=InnoDB;
  `;
  await pool.query(createTableSQL);
  return pool;
}

let dbPoolPromise = initDb();

// Basic command parser
function parseCommand(text) {
  // Normalize
  const parts = text.trim().split(/\s+/);
  // Expect: TOPUP <service> <number> <nominal>
  if (parts.length >= 4 && parts[0].toUpperCase() === 'TOPUP') {
    return {
      cmd: 'TOPUP',
      service: parts[1].toUpperCase(),
      number: parts[2],
      nominal: parts[3]
    };
  }
  // Additional commands can be parsed here (STATUS <order_id>, HELP, etc.)
  return null;
}

// Webhook verify
app.get('/webhook', (req, res) => {
  const mode = req.query['hub.mode'];
  const token = req.query['hub.verify_token'];
  const challenge = req.query['hub.challenge'];

  if (mode && token) {
    if (mode === 'subscribe' && token === VERIFY_TOKEN) {
      console.log('WEBHOOK_VERIFIED');
      res.status(200).send(challenge);
    } else {
      res.sendStatus(403);
    }
  } else {
    res.sendStatus(400);
  }
});

// Webhook receiver for incoming messages
app.post('/webhook', async (req, res) => {
  // Acknowledge quickly
  res.sendStatus(200);

  try {
    const entry = req.body.entry && req.body.entry[0];
    if (!entry) return;
    const changes = entry.changes && entry.changes[0];
    const value = changes && changes.value;
    const messages = value && value.messages && value.messages[0];
    if (!messages) return;

    const from = messages.from; // phone number of sender
    const text = (messages.text && messages.text.body) || '';
    console.log('Incoming message from', from, 'text:', text);

    const cmd = parseCommand(text);
    if (!cmd) {
      await sendWhatsAppMessage(from, 'Perintah tidak dikenali. Contoh: TOPUP PULSA 08123456789 25000');
      return;
    }

    if (cmd.cmd === 'TOPUP') {
      const pool = await dbPoolPromise;
      const orderId = 'ORD' + Date.now();

      // Insert order with status PENDING
      await pool.query('INSERT INTO orders (order_id, user_phone, service, target, nominal, status) VALUES (?, ?, ?, ?, ?, ?)',
        [orderId, from, cmd.service, cmd.number, cmd.nominal, 'PENDING']);

      await sendWhatsAppMessage(from, `Order diterima. Order ID: ${orderId}. Sedang diproses...`);

      // Call provider API
      try {
        const provResp = await callProviderTopup(cmd.service, cmd.number, cmd.nominal, orderId);

        // Update DB
        await pool.query('UPDATE orders SET status = ?, provider_response = ? WHERE order_id = ?',
          [ 'SUCCESS', JSON.stringify(provResp), orderId ]);

        await sendWhatsAppMessage(from, `Topup berhasil! Order ID: ${orderId}. Provider response: ${JSON.stringify(provResp)}`);

      } catch (err) {
        const errMsg = err.response && err.response.data ? JSON.stringify(err.response.data) : err.message;
        await pool.query('UPDATE orders SET status = ?, provider_response = ? WHERE order_id = ?',
          [ 'FAILED', errMsg, orderId ]);
        await sendWhatsAppMessage(from, `Topup gagal. Order ID: ${orderId}. Error: ${errMsg}`);
      }
    }

  } catch (err) {
    console.error('Error handling webhook', err);
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`WA Topup bot listening on port ${PORT}`));

/*
Next steps / How to adapt to AL KONEK or other provider:
1. If AL KONEK has API docs, replace PROVIDER_API_URL and callProviderTopup() payload/headers to match their spec.
   - Some providers use GET, some POST. Some require HMAC signature. Some return async callbacks (you must handle provider webhook).
2. If provider returns async status, implement an endpoint (e.g. /provider-callback) and update order status in DB when callback arrives.
3. For production, secure your .env, use HTTPS, and consider queueing (Bull, RabbitMQ) for high throughput.
4. Optionally add payment integration (Midtrans/Xendit/Tripay) so customers can pay before the bot triggers the topup.

If you want, saya bisa:
- Sesuaikan kode ini langsung dengan API AL KONEK kalau kamu kirimkan dokumentasi API mereka.
- Buat versi untuk WA gateway lain (contoh: Fonnte / Twilio) kalau kamu tidak mau pakai WhatsApp Cloud API.
*/